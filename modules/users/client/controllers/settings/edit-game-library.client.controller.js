'use strict';

angular.module('users').controller('EditGameLibraryController', ['$scope', '$http', '$filter', 'Game', 'Users', 'Authentication',
  function($scope, $http, $filter, Game, Users, Authentication) {
    $scope.user = Authentication.user;

//gets all games to populate list of games to choose from
    Game.query(function(data) {
      $scope.games = data;
      $scope.buildPager();
    });

    $scope.buildPager = function () {
      $scope.pagedItems = [];
      $scope.itemsPerPage = 15;
      $scope.currentPage = 1;
      $scope.figureOutItemsToDisplay();
    };

    $scope.figureOutItemsToDisplay = function () {
      $scope.filteredItems = $filter('filter')($scope.games, {
        $: $scope.search
      });
      $scope.filterLength = $scope.filteredItems.length;
      var begin = (($scope.currentPage - 1) * $scope.itemsPerPage);
      var end = begin + $scope.itemsPerPage;
      $scope.pagedItems = $scope.filteredItems.slice(begin, end);
    };

    $scope.pageChanged = function () {
      $scope.figureOutItemsToDisplay();
    };

//adds the selected game to the current users games array
    $scope.addGameToLibrary = function (game) {
      $scope.user.games.push(game);
      console.log(game);

      var user = new Users($scope.user);

      user.$update(function (response) {
        $scope.$broadcast('show-errors-reset', 'userForm');

        $scope.success = true;
        Authentication.user = response;
      }, function (response) {
        $scope.error = response.data.message;
      });
    };
  }
]);
